<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEMSIS XML Viewer</title>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0e14;
            --bg-secondary: #121820;
            --bg-tertiary: #1a2230;
            --bg-card: #151c28;
            --accent-blue: #3b82f6;
            --accent-cyan: #22d3ee;
            --accent-emerald: #10b981;
            --accent-amber: #f59e0b;
            --accent-rose: #f43f5e;
            --text-primary: #f1f5f9;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --border-color: #1e293b;
            --glow-blue: rgba(59, 130, 246, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* Animated background */
        .bg-pattern {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                radial-gradient(ellipse 80% 50% at 50% -20%, rgba(59, 130, 246, 0.15), transparent),
                radial-gradient(ellipse 60% 40% at 100% 100%, rgba(16, 185, 129, 0.1), transparent);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
            position: relative;
            z-index: 1;
        }

        /* Header */
        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: fadeInDown 0.6s ease-out;
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-cyan), var(--accent-blue));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            letter-spacing: -0.02em;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            font-weight: 300;
        }

        /* Upload Zone */
        .upload-zone {
            background: var(--bg-card);
            border: 2px dashed var(--border-color);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 2rem;
            animation: fadeIn 0.6s ease-out 0.2s both;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: var(--accent-blue);
            background: var(--bg-tertiary);
            box-shadow: 0 0 40px var(--glow-blue);
        }

        .upload-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            stroke: var(--accent-cyan);
            opacity: 0.8;
        }

        .upload-text {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .upload-hint {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        #fileInput {
            display: none;
        }

        /* Stats Bar */
        .stats-bar {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
            animation: fadeIn 0.4s ease-out;
        }

        .stats-bar.visible {
            display: grid;
        }

        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
            text-align: center;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 0.85rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 0.25rem;
        }

        /* Tabs */
        .tabs {
            display: none;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tabs.visible {
            display: flex;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab:hover {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .tab.active {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        /* Content Panels */
        .content-panel {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }

        .content-panel.active {
            display: block;
        }

        /* Section Cards */
        .section-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            margin-bottom: 1.5rem;
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.25rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .section-header:hover {
            background: var(--bg-secondary);
        }

        .section-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .section-badge {
            font-size: 0.75rem;
            padding: 0.2rem 0.6rem;
            background: var(--accent-blue);
            color: white;
            border-radius: 20px;
            font-family: 'JetBrains Mono', monospace;
        }

        .section-toggle {
            width: 24px;
            height: 24px;
            stroke: var(--text-muted);
            transition: transform 0.3s ease;
        }

        .section-header.collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 1.25rem;
            max-height: 600px;
            overflow-y: auto;
        }

        .section-content.collapsed {
            display: none;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-weight: 500;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.05em;
        }

        .data-table td {
            color: var(--text-primary);
        }

        .data-table tr:hover td {
            background: var(--bg-tertiary);
        }

        .field-name {
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.85rem;
        }

        .field-value {
            color: var(--text-primary);
            word-break: break-word;
        }

        .field-value.code {
            font-family: 'JetBrains Mono', monospace;
            color: var(--accent-amber);
        }

        /* Narrative Box */
        .narrative-box {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.5rem;
            font-size: 0.95rem;
            line-height: 1.8;
            color: var(--text-primary);
            white-space: pre-wrap;
            max-height: 500px;
            overflow-y: auto;
        }

        /* Vitals Grid */
        .vitals-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }

        .vital-card {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 1rem;
        }

        .vital-time {
            font-size: 0.8rem;
            color: var(--accent-cyan);
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .vital-time::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent-emerald);
            border-radius: 50%;
        }

        .vital-readings {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.5rem;
        }

        .vital-item {
            display: flex;
            flex-direction: column;
        }

        .vital-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .vital-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        /* Images Section */
        .images-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .image-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            overflow: hidden;
        }

        .image-header {
            padding: 1rem;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
        }

        .image-title {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .image-meta {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
        }

        .image-container {
            padding: 1rem;
            text-align: center;
            background: #000;
        }

        .image-container img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }

        /* Raw XML */
        .raw-xml {
            background: var(--bg-tertiary);
            border-radius: 8px;
            padding: 1.5rem;
            overflow-x: auto;
            max-height: 700px;
            overflow-y: auto;
        }

        .raw-xml pre {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            color: var(--text-secondary);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .raw-xml .tag {
            color: var(--accent-rose);
        }

        .raw-xml .attr-name {
            color: var(--accent-amber);
        }

        .raw-xml .attr-value {
            color: var(--accent-emerald);
        }

        .raw-xml .content {
            color: var(--text-primary);
        }

        /* Search Bar */
        .search-bar {
            display: none;
            margin-bottom: 1.5rem;
        }

        .search-bar.visible {
            display: block;
        }

        .search-input {
            width: 100%;
            padding: 1rem 1.5rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-family: 'Outfit', sans-serif;
            transition: all 0.2s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 20px var(--glow-blue);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-color);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: var(--text-muted);
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            h1 {
                font-size: 1.75rem;
            }

            .upload-zone {
                padding: 2rem 1rem;
            }

            .stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }

            .images-grid {
                grid-template-columns: 1fr;
            }

            .vitals-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="bg-pattern"></div>
    
    <div class="container">
        <header>
            <h1>NEMSIS XML Viewer</h1>
            <p class="subtitle">Upload and explore EMS patient care reports</p>
        </header>

        <div class="upload-zone" id="uploadZone">
            <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="17 8 12 3 7 8"/>
                <line x1="12" y1="3" x2="12" y2="15"/>
            </svg>
            <p class="upload-text">Drop your XML file here or click to upload</p>
            <p class="upload-hint">Supports NEMSIS 3.x format</p>
            <input type="file" id="fileInput" accept=".xml">
        </div>

        <div class="stats-bar" id="statsBar">
            <div class="stat-card">
                <div class="stat-value" id="statPatient">-</div>
                <div class="stat-label">Patient</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statVitals">0</div>
                <div class="stat-label">Vital Sets</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statImages">0</div>
                <div class="stat-label">Images</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="statAgency">-</div>
                <div class="stat-label">Agency</div>
            </div>
        </div>

        <div class="search-bar" id="searchBar">
            <input type="text" class="search-input" id="searchInput" placeholder="Search fields, values, or content...">
        </div>

        <div class="tabs" id="tabs">
            <button class="tab active" data-tab="overview">Overview</button>
            <button class="tab" data-tab="patient">Patient</button>
            <button class="tab" data-tab="vitals">Vitals</button>
            <button class="tab" data-tab="narrative">Narrative</button>
            <button class="tab" data-tab="images">Images</button>
            <button class="tab" data-tab="all">All Fields</button>
            <button class="tab" data-tab="raw">Raw XML</button>
        </div>

        <div id="content">
            <!-- Content will be dynamically inserted here -->
        </div>
    </div>

    <script>
        class NEMSISViewer {
            constructor() {
                this.xmlDoc = null;
                this.rawXML = '';
                this.parsedData = {};
                this.base64Images = [];
                
                this.initEventListeners();
            }

            initEventListeners() {
                const uploadZone = document.getElementById('uploadZone');
                const fileInput = document.getElementById('fileInput');
                const tabs = document.getElementById('tabs');
                const searchInput = document.getElementById('searchInput');

                uploadZone.addEventListener('click', () => fileInput.click());
                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });
                uploadZone.addEventListener('dragleave', () => {
                    uploadZone.classList.remove('dragover');
                });
                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file) this.loadFile(file);
                });

                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) this.loadFile(file);
                });

                tabs.addEventListener('click', (e) => {
                    if (e.target.classList.contains('tab')) {
                        this.switchTab(e.target.dataset.tab);
                    }
                });

                searchInput.addEventListener('input', (e) => {
                    this.filterContent(e.target.value);
                });
            }

            loadFile(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    this.rawXML = e.target.result;
                    this.parseXML(this.rawXML);
                };
                reader.readAsText(file);
            }

            parseXML(xmlString) {
                const parser = new DOMParser();
                this.xmlDoc = parser.parseFromString(xmlString, 'text/xml');
                
                // Check for parsing errors
                const parseError = this.xmlDoc.querySelector('parsererror');
                if (parseError) {
                    alert('Error parsing XML file. Please check the file format.');
                    return;
                }

                this.extractData();
                this.findBase64Images();
                this.updateStats();
                this.showUI();
                this.renderTab('overview');
            }

            extractData() {
                const data = {};
                
                // Patient info
                data.patient = this.extractSection('ePatient');
                data.response = this.extractSection('eResponse');
                data.dispatch = this.extractSection('eDispatch');
                data.crew = this.extractSection('eCrew');
                data.times = this.extractSection('eTimes');
                data.scene = this.extractSection('eScene');
                data.situation = this.extractSection('eSituation');
                data.history = this.extractSection('eHistory');
                data.vitals = this.extractVitals();
                data.narrative = this.extractNarrative();
                data.arrest = this.extractSection('eArrest');
                data.injury = this.extractSection('eInjury');
                data.payment = this.extractSection('ePayment');
                
                this.parsedData = data;
            }

            extractSection(sectionName) {
                const section = this.xmlDoc.querySelector(sectionName);
                if (!section) return null;
                return this.elementToObject(section);
            }

            elementToObject(element) {
                const obj = {};
                
                // Get attributes
                for (const attr of element.attributes) {
                    obj[`@${attr.name}`] = attr.value;
                }
                
                // Get child elements
                for (const child of element.children) {
                    const key = child.tagName;
                    const value = child.children.length > 0 
                        ? this.elementToObject(child) 
                        : child.textContent;
                    
                    if (obj[key]) {
                        if (!Array.isArray(obj[key])) {
                            obj[key] = [obj[key]];
                        }
                        obj[key].push(value);
                    } else {
                        obj[key] = value;
                    }
                }
                
                return obj;
            }

            extractVitals() {
                const vitalsGroups = this.xmlDoc.querySelectorAll('eVitals\\.VitalGroup');
                return Array.from(vitalsGroups).map(group => this.elementToObject(group));
            }

            extractNarrative() {
                const narrative = this.xmlDoc.querySelector('eNarrative\\.01');
                return narrative ? narrative.textContent : null;
            }

            findBase64Images() {
                this.base64Images = [];
                
                // Find all elements that might contain base64 data
                const allElements = this.xmlDoc.querySelectorAll('*');
                const base64Regex = /^[A-Za-z0-9+/]+=*$/;
                
                for (const el of allElements) {
                    const text = el.textContent.trim();
                    // Check if it looks like base64 and is reasonably long
                    if (text.length > 100 && base64Regex.test(text.replace(/\s/g, ''))) {
                        // Try to detect if it's a PNG or image
                        const cleanBase64 = text.replace(/\s/g, '');
                        try {
                            const decoded = atob(cleanBase64.substring(0, 20));
                            // Check for PNG signature
                            if (decoded.includes('PNG') || decoded.charCodeAt(0) === 0x89) {
                                this.base64Images.push({
                                    element: el.tagName,
                                    parentElement: el.parentElement?.tagName || 'root',
                                    data: cleanBase64,
                                    type: 'image/png'
                                });
                            }
                            // Check for JPEG signature
                            else if (decoded.charCodeAt(0) === 0xFF && decoded.charCodeAt(1) === 0xD8) {
                                this.base64Images.push({
                                    element: el.tagName,
                                    parentElement: el.parentElement?.tagName || 'root',
                                    data: cleanBase64,
                                    type: 'image/jpeg'
                                });
                            }
                        } catch (e) {
                            // Not valid base64, skip
                        }
                    }
                }
            }

            updateStats() {
                // Patient name
                const firstName = this.parsedData.patient?.['ePatient.PatientNameGroup']?.['ePatient.02'] || '';
                const lastName = this.parsedData.patient?.['ePatient.PatientNameGroup']?.['ePatient.03'] || '';
                document.getElementById('statPatient').textContent = 
                    firstName || lastName ? `${firstName} ${lastName}`.trim() : 'N/A';
                
                // Vitals count
                document.getElementById('statVitals').textContent = this.parsedData.vitals?.length || 0;
                
                // Images count
                document.getElementById('statImages').textContent = this.base64Images.length;
                
                // Agency
                const agency = this.parsedData.response?.['eResponse.AgencyGroup']?.['eResponse.02'] || 'N/A';
                document.getElementById('statAgency').textContent = 
                    agency.length > 15 ? agency.substring(0, 15) + '...' : agency;
            }

            showUI() {
                document.getElementById('statsBar').classList.add('visible');
                document.getElementById('tabs').classList.add('visible');
                document.getElementById('searchBar').classList.add('visible');
            }

            switchTab(tabName) {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
                this.renderTab(tabName);
            }

            renderTab(tabName) {
                const content = document.getElementById('content');
                
                switch (tabName) {
                    case 'overview':
                        content.innerHTML = this.renderOverview();
                        break;
                    case 'patient':
                        content.innerHTML = this.renderPatient();
                        break;
                    case 'vitals':
                        content.innerHTML = this.renderVitals();
                        break;
                    case 'narrative':
                        content.innerHTML = this.renderNarrative();
                        break;
                    case 'images':
                        content.innerHTML = this.renderImages();
                        break;
                    case 'all':
                        content.innerHTML = this.renderAllFields();
                        break;
                    case 'raw':
                        content.innerHTML = this.renderRawXML();
                        break;
                }

                this.initSectionToggles();
            }

            renderOverview() {
                const sections = [
                    { title: 'Response', data: this.parsedData.response, icon: 'üöë' },
                    { title: 'Dispatch', data: this.parsedData.dispatch, icon: 'üìû' },
                    { title: 'Scene', data: this.parsedData.scene, icon: 'üìç' },
                    { title: 'Situation', data: this.parsedData.situation, icon: '‚ö†Ô∏è' },
                    { title: 'Times', data: this.parsedData.times, icon: '‚è±Ô∏è' },
                    { title: 'Crew', data: this.parsedData.crew, icon: 'üë•' },
                ];

                return sections.map(s => this.renderSection(s.title, s.data, s.icon)).join('');
            }

            renderPatient() {
                const sections = [
                    { title: 'Patient Demographics', data: this.parsedData.patient, icon: 'üë§' },
                    { title: 'Medical History', data: this.parsedData.history, icon: 'üìã' },
                    { title: 'Payment/Insurance', data: this.parsedData.payment, icon: 'üí≥' },
                ];

                return sections.map(s => this.renderSection(s.title, s.data, s.icon)).join('');
            }

            renderVitals() {
                if (!this.parsedData.vitals || this.parsedData.vitals.length === 0) {
                    return '<div class="empty-state">No vitals data found</div>';
                }

                const vitalsCards = this.parsedData.vitals.map(vital => {
                    const time = vital['eVitals.01'] || 'Unknown time';
                    const readings = [];
                    
                    // Blood Pressure
                    const bp = vital['eVitals.BloodPressureGroup'];
                    if (bp) {
                        const sys = bp['eVitals.06'] || '-';
                        const dia = bp['eVitals.07'] || '-';
                        const map = bp['eVitals.09'] || '-';
                        readings.push({ label: 'BP', value: `${sys}/${dia}` });
                        readings.push({ label: 'MAP', value: map });
                    }
                    
                    // Heart Rate
                    const hr = vital['eVitals.HeartRateGroup'];
                    if (hr) {
                        readings.push({ label: 'HR', value: hr['eVitals.10'] || '-' });
                    }
                    
                    // SpO2
                    if (vital['eVitals.12']) {
                        readings.push({ label: 'SpO2', value: `${vital['eVitals.12']}%` });
                    }
                    
                    // Resp Rate
                    if (vital['eVitals.14']) {
                        readings.push({ label: 'RR', value: vital['eVitals.14'] });
                    }
                    
                    // Temperature
                    const temp = vital['eVitals.TemperatureGroup'];
                    if (temp && temp['eVitals.24']) {
                        readings.push({ label: 'Temp', value: `${temp['eVitals.24']}¬∞C` });
                    }
                    
                    // GCS
                    const gcs = vital['eVitals.GlasgowScoreGroup'];
                    if (gcs && gcs['eVitals.23']) {
                        readings.push({ label: 'GCS', value: gcs['eVitals.23'] });
                    }
                    
                    // ETCO2
                    if (vital['eVitals.33']) {
                        readings.push({ label: 'ETCO2', value: vital['eVitals.33'] });
                    }

                    return `
                        <div class="vital-card">
                            <div class="vital-time">${this.formatDateTime(time)}</div>
                            <div class="vital-readings">
                                ${readings.map(r => `
                                    <div class="vital-item">
                                        <span class="vital-label">${r.label}</span>
                                        <span class="vital-value">${r.value}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }).join('');

                return `
                    <div class="section-card">
                        <div class="section-header">
                            <span class="section-title">
                                üìä Vital Signs
                                <span class="section-badge">${this.parsedData.vitals.length}</span>
                            </span>
                        </div>
                        <div class="section-content">
                            <div class="vitals-grid">
                                ${vitalsCards}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderNarrative() {
                if (!this.parsedData.narrative) {
                    return '<div class="empty-state">No narrative found</div>';
                }

                return `
                    <div class="section-card">
                        <div class="section-header">
                            <span class="section-title">üìù Clinical Narrative</span>
                        </div>
                        <div class="section-content">
                            <div class="narrative-box">${this.escapeHtml(this.parsedData.narrative)}</div>
                        </div>
                    </div>
                `;
            }

            renderImages() {
                if (this.base64Images.length === 0) {
                    return '<div class="empty-state">No embedded images found</div>';
                }

                return `
                    <div class="section-card">
                        <div class="section-header">
                            <span class="section-title">
                                üñºÔ∏è Embedded Images
                                <span class="section-badge">${this.base64Images.length}</span>
                            </span>
                        </div>
                        <div class="section-content">
                            <div class="images-grid">
                                ${this.base64Images.map((img, idx) => `
                                    <div class="image-card">
                                        <div class="image-header">
                                            <div class="image-title">Image ${idx + 1}</div>
                                            <div class="image-meta">${img.parentElement} ‚Üí ${img.element} (${img.type})</div>
                                        </div>
                                        <div class="image-container">
                                            <img src="data:${img.type};base64,${img.data}" alt="Embedded image ${idx + 1}">
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderAllFields() {
                const allSections = [
                    'eRecord', 'eResponse', 'eDispatch', 'eCrew', 'eTimes', 
                    'ePatient', 'ePayment', 'eScene', 'eSituation', 'eInjury',
                    'eArrest', 'eHistory', 'eNarrative', 'eVitals', 'eMedications',
                    'eProcedures', 'eDisposition', 'eOutcome', 'eOther', 'eCustomResults'
                ];

                let html = '';
                for (const sectionName of allSections) {
                    const section = this.xmlDoc.querySelector(sectionName);
                    if (section) {
                        html += this.renderSection(sectionName, this.elementToObject(section), 'üìÅ');
                    }
                }

                return html || '<div class="empty-state">No data found</div>';
            }

            renderRawXML() {
                const highlighted = this.highlightXML(this.rawXML);
                return `
                    <div class="section-card">
                        <div class="section-header">
                            <span class="section-title">üî§ Raw XML</span>
                        </div>
                        <div class="section-content">
                            <div class="raw-xml">
                                <pre>${highlighted}</pre>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderSection(title, data, icon = 'üìÅ') {
                if (!data) {
                    return '';
                }

                const fields = this.flattenObject(data);
                const fieldCount = Object.keys(fields).length;

                return `
                    <div class="section-card" data-section="${title}">
                        <div class="section-header">
                            <span class="section-title">
                                ${icon} ${title}
                                <span class="section-badge">${fieldCount}</span>
                            </span>
                            <svg class="section-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </div>
                        <div class="section-content">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th>Field</th>
                                        <th>Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${Object.entries(fields).map(([key, value]) => `
                                        <tr>
                                            <td class="field-name">${this.escapeHtml(key)}</td>
                                            <td class="field-value ${this.isCode(value) ? 'code' : ''}">${this.formatValue(value)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                `;
            }

            flattenObject(obj, prefix = '') {
                const result = {};
                
                for (const [key, value] of Object.entries(obj)) {
                    const newKey = prefix ? `${prefix}.${key}` : key;
                    
                    if (value && typeof value === 'object' && !Array.isArray(value)) {
                        Object.assign(result, this.flattenObject(value, newKey));
                    } else if (Array.isArray(value)) {
                        value.forEach((item, idx) => {
                            if (typeof item === 'object') {
                                Object.assign(result, this.flattenObject(item, `${newKey}[${idx}]`));
                            } else {
                                result[`${newKey}[${idx}]`] = item;
                            }
                        });
                    } else {
                        result[newKey] = value;
                    }
                }
                
                return result;
            }

            formatValue(value) {
                if (value === null || value === undefined || value === '') {
                    return '<span style="color: var(--text-muted)">‚Äî</span>';
                }
                
                // Truncate very long base64 strings
                if (typeof value === 'string' && value.length > 200) {
                    const isBase64 = /^[A-Za-z0-9+/]+=*$/.test(value.replace(/\s/g, ''));
                    if (isBase64) {
                        return `<span style="color: var(--accent-emerald)">[Base64 Data - ${value.length} chars]</span>`;
                    }
                    return this.escapeHtml(value.substring(0, 200)) + '...';
                }
                
                return this.escapeHtml(String(value));
            }

            isCode(value) {
                if (typeof value !== 'string') return false;
                return /^\d{7}$/.test(value) || /^[A-Z]\d+$/.test(value) || /^\d{4}-\d{2}-\d{2}/.test(value);
            }

            formatDateTime(dateStr) {
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleString('en-US', {
                        month: 'short',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } catch {
                    return dateStr;
                }
            }

            highlightXML(xml) {
                let escaped = this.escapeHtml(xml);
                
                // Highlight tags
                escaped = escaped.replace(/&lt;(\/?[\w\.\-:]+)/g, '&lt;<span class="tag">$1</span>');
                
                // Highlight attributes
                escaped = escaped.replace(/(\s)([\w\-:]+)=/g, '$1<span class="attr-name">$2</span>=');
                
                // Highlight attribute values
                escaped = escaped.replace(/="([^"]*)"/g, '="<span class="attr-value">$1</span>"');
                
                return escaped;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            initSectionToggles() {
                document.querySelectorAll('.section-header').forEach(header => {
                    header.addEventListener('click', () => {
                        header.classList.toggle('collapsed');
                        header.nextElementSibling.classList.toggle('collapsed');
                    });
                });
            }

            filterContent(query) {
                if (!query) {
                    document.querySelectorAll('.data-table tr').forEach(row => {
                        row.style.display = '';
                    });
                    return;
                }

                const lowerQuery = query.toLowerCase();
                document.querySelectorAll('.data-table tbody tr').forEach(row => {
                    const text = row.textContent.toLowerCase();
                    row.style.display = text.includes(lowerQuery) ? '' : 'none';
                });
            }
        }

        // Initialize viewer
        const viewer = new NEMSISViewer();
    </script>
</body>
</html>
